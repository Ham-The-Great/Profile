<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSM Navigation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 80vh; width: 100%; }
        #controls { padding: 10px; text-align: center; }
        #instructions { padding: 10px; }
        input { margin: 5px; padding: 5px; width: 200px; }
        button { padding: 5px 10px; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.8); padding: 10px; }
    </style>
</head>
<body>
    <div id="controls">
        <input type="text" id="start" placeholder="Start address or lat,lon">
        <button id="use-current">Use Current Location</button>
        <input type="text" id="end" placeholder="End address or lat,lon">
        <button id="route-btn">Get Route</button>
    </div>
    <div id="map"></div>
    <div id="instructions"></div>
    <div id="loading" style="display: none;">Loading...</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>
    <script>
        var map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var routeLine;
        var startMarker;
        var endMarker;
        var currentMarker;

        function isCoordinate(str) {
            var parts = str.split(',');
            if (parts.length === 2) {
                var lat = parseFloat(parts[0]);
                var lon = parseFloat(parts[1]);
                if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                    return [lat, lon];
                }
            }
            return false;
        }

        $('#use-current').click(function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    var currentLocation = [lat, lon];
                    if (currentMarker) map.removeLayer(currentMarker);
                    currentMarker = L.marker(currentLocation).addTo(map).bindPopup('You are here').openPopup();
                    map.setView(currentLocation, 15);
                    $.getJSON(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, function(data) {
                        $('#start').val(data.display_name);
                    }).fail(function() {
                        $('#start').val(`${lat},${lon}`);
                    });
                }, function() {
                    alert('Unable to get location');
                });
            } else {
                alert('Geolocation not supported');
            }
        });

        $('#route-btn').click(function() {
            var start = $('#start').val();
            var end = $('#end').val();
            if (!start || !end) {
                alert('Please enter both start and end');
                return;
            }
            $('#loading').show();
            var startCoord = isCoordinate(start);
            if (startCoord) {
                processEnd(startCoord, end);
            } else {
                $.getJSON('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(start), function(data) {
                    if (data.length > 0) {
                        startCoord = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                        processEnd(startCoord, end);
                    } else {
                        alert('Start address not found');
                        $('#loading').hide();
                    }
                }).fail(function() {
                    alert('Error geocoding start address');
                    $('#loading').hide();
                });
            }
        });

        function processEnd(startCoord, end) {
            var endCoord = isCoordinate(end);
            if (endCoord) {
                getRoute(startCoord, endCoord);
            } else {
                $.getJSON('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(end), function(data) {
                    if (data.length > 0) {
                        endCoord = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                        getRoute(startCoord, endCoord);
                    } else {
                        alert('End address not found');
                        $('#loading').hide();
                    }
                }).fail(function() {
                    alert('Error geocoding end address');
                    $('#loading').hide();
                });
            }
        }

        function getRoute(start, end) {
           var url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&steps=true`;

var xhr = new XMLHttpRequest();
xhr.open("GET", url, true);
xhr.onload = function () {
  if (xhr.status === 200) {
    var data = JSON.parse(xhr.responseText);
    console.log("Route data:", data);
    // Process your route data here
  } else {
    console.error("Request failed with status:", xhr.status);
  }
};
xhr.send();
        }

        function drawRoute(geometry, start, end) {
            if (routeLine) map.removeLayer(routeLine);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            var coords = polyline.decode(geometry);
            var latLngs = coords.map(c => [c[0], c[1]]);
            routeLine = L.polyline(latLngs, {color: 'blue'}).addTo(map);
            startMarker = L.marker(start).addTo(map).bindPopup('Start');
            endMarker = L.marker(end).addTo(map).bindPopup('End');
            map.fitBounds(routeLine.getBounds());
        }

        function displayRouteInfo(route) {
            var distance = (route.distance / 1000).toFixed(2); // km
            var duration = (route.duration / 60).toFixed(2); // minutes
            var instructions = '<h3>Route Info</h3>';
            instructions += `<p>Distance: ${distance} km</p>`;
            instructions += `<p>Duration: ${duration} minutes</p>`;
            instructions += '<ol>';
            route.legs[0].steps.forEach(step => {
                instructions += `<li>${step.maneuver.instruction}</li>`;
            });
            instructions += '</ol>';
            $('#instructions').html(instructions);
        }
    </script>
</body>
</html>
